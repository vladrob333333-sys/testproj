{% extends "base.html" %}

{% block title %}Мои заказы - Ресторан "Гурман"{% endblock %}

{% block content %}
<div class="container">
    <h1 class="section-title">История заказов</h1>
    
    <div class="orders-header">
        <div class="realtime-indicator" id="realtime-indicator">
            <i class="fas fa-sync-alt"></i>
            <span>Обновление в реальном времени</span>
        </div>
        <button class="btn btn-small" onclick="refreshOrders()">
            <i class="fas fa-redo"></i> Обновить
        </button>
    </div>
    
    <div id="orders-container">
        {% if orders %}
            <div class="orders-list">
                {% for order in orders %}
                <div class="order-card" id="order-{{ order.id }}">
                    <div class="order-header">
                        <div class="order-id">Заказ #{{ order.id }}</div>
                        <div class="order-date">{{ order.created_at.strftime('%d.%m.%Y %H:%M') }}</div>
                        <div class="order-status status-{{ order.status }}">
                            {{ get_status_text(order.status) }}
                        </div>
                    </div>
                    
                    <div class="order-body">
                        <div class="order-items">
                            <h4>Состав заказа:</h4>
                            {% for item in order.items %}
                            <div class="order-item">
                                <span class="item-name">{{ item.menu_item.name }}</span>
                                <span class="item-quantity">× {{ item.quantity }}</span>
                                <span class="item-price">{{ item.price_at_time * item.quantity }} BYN</span>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="order-info">
                            <div class="info-row">
                                <span>Адрес доставки:</span>
                                <span>{{ order.delivery_address }}</span>
                            </div>
                            <div class="info-row">
                                <span>Телефон:</span>
                                <span>{{ order.phone }}</span>
                            </div>
                            {% if order.notes %}
                            <div class="info-row">
                                <span>Комментарий:</span>
                                <span>{{ order.notes }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="order-footer">
                        <div class="order-total">
                            <span>Итого:</span>
                            <span class="total-amount">{{ order.total_amount }} BYN</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-orders">
                <div class="empty-icon">
                    <i class="fas fa-shopping-basket"></i>
                </div>
                <h3>У вас пока нет заказов</h3>
                <p>Сделайте свой первый заказ прямо сейчас!</p>
                <a href="{{ url_for('menu') }}" class="btn btn-primary">Перейти в меню</a>
            </div>
        {% endif %}
    </div>
</div>

<style>
    .orders-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .realtime-indicator {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--primary-color);
        font-weight: 500;
    }
    
    .realtime-indicator i {
        animation: spin 2s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .realtime-indicator.active i {
        animation: none;
        color: var(--success);
    }
    
    .realtime-notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--success);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .new-order-badge {
        background: var(--success);
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.8rem;
        margin-left: 10px;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .order-card.new-order {
        border-left: 4px solid var(--success);
        animation: highlight 3s;
    }
    
    @keyframes highlight {
        0% { background-color: rgba(46, 139, 87, 0.1); }
        100% { background-color: transparent; }
    }
    
    .order-card.status-updated {
        border-left: 4px solid var(--info);
        animation: highlightBlue 3s;
    }
    
    @keyframes highlightBlue {
        0% { background-color: rgba(52, 152, 219, 0.1); }
        100% { background-color: transparent; }
    }
</style>

<script>
    let lastCheckTime = null;
    let checkInterval = null;
    let isConnected = true;
    
    // Функция обновления списка заказов
    function refreshOrders() {
        fetch('/api/user/orders/update')
            .then(response => response.json())
            .then(orders => {
                renderOrders(orders);
            })
            .catch(error => {
                console.error('Ошибка обновления заказов:', error);
            });
    }
    
    // Функция отображения заказов
    function renderOrders(orders) {
        const container = document.getElementById('orders-container');
        
        if (!orders || orders.length === 0) {
            container.innerHTML = `
                <div class="empty-orders">
                    <div class="empty-icon">
                        <i class="fas fa-shopping-basket"></i>
                    </div>
                    <h3>У вас пока нет заказов</h3>
                    <p>Сделайте свой первый заказ прямо сейчас!</p>
                    <a href="{{ url_for('menu') }}" class="btn btn-primary">Перейти в меню</a>
                </div>
            `;
            return;
        }
        
        let html = '<div class="orders-list">';
        
        orders.forEach(order => {
            html += `
                <div class="order-card" id="order-${order.id}">
                    <div class="order-header">
                        <div class="order-id">Заказ #${order.id}</div>
                        <div class="order-date">${order.created_at}</div>
                        <div class="order-status status-${order.status}">
                            ${getStatusText(order.status)}
                        </div>
                    </div>
                    
                    <div class="order-body">
                        <div class="order-items">
                            <h4>Состав заказа:</h4>
            `;
            
            if (order.items && order.items.length > 0) {
                order.items.forEach(item => {
                    html += `
                        <div class="order-item">
                            <span class="item-name">${item.name}</span>
                            <span class="item-quantity">× ${item.quantity}</span>
                            <span class="item-price">${item.price * item.quantity} BYN</span>
                        </div>
                    `;
                });
                
                if (order.items_count > 5) {
                    html += `<div class="more-items">... и еще ${order.items_count - 5} позиций</div>`;
                }
            }
            
            html += `
                        </div>
                        
                        <div class="order-info">
                            <div class="info-row">
                                <span>Адрес доставки:</span>
                                <span>${order.delivery_address}</span>
                            </div>
                            <div class="info-row">
                                <span>Телефон:</span>
                                <span>${order.phone}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="order-footer">
                        <div class="order-total">
                            <span>Итого:</span>
                            <span class="total-amount">${order.total_amount} BYN</span>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
    }
    
    // Функция проверки новых заказов
    function checkForNewOrders() {
        const params = lastCheckTime ? `?last_check=${encodeURIComponent(lastCheckTime)}` : '';
        
        fetch(`/api/orders/check_new${params}`)
            .then(response => response.json())
            .then(data => {
                if (data.has_new) {
                    showNewOrderNotification(data.count);
                    refreshOrders();
                }
                lastCheckTime = data.timestamp;
            })
            .catch(error => {
                console.error('Ошибка проверки новых заказов:', error);
                isConnected = false;
                updateConnectionStatus();
            });
    }
    
    // Функция получения обновлений в реальном времени
    function checkRealtimeUpdates() {
        const params = lastCheckTime ? `?last_timestamp=${encodeURIComponent(lastCheckTime)}` : '';
        
        fetch(`/api/realtime/updates${params}`)
            .then(response => response.json())
            .then(data => {
                if (data.updates && data.updates.length > 0) {
                    data.updates.forEach(update => {
                        handleRealtimeUpdate(update);
                    });
                }
                lastCheckTime = data.timestamp;
                isConnected = true;
                updateConnectionStatus();
            })
            .catch(error => {
                console.error('Ошибка получения обновлений:', error);
                isConnected = false;
                updateConnectionStatus();
            });
    }
    
    // Обработка обновлений в реальном времени
    function handleRealtimeUpdate(update) {
        switch (update.type) {
            case 'new_order':
                showOrderNotification(`Новый заказ #${update.data.order_id} создан!`);
                highlightOrder(update.data.order_id, 'new-order');
                break;
                
            case 'order_status_changed':
                showOrderNotification(`Статус заказа #${update.data.order_id} изменен на: ${update.data.status_text}`);
                highlightOrder(update.data.order_id, 'status-updated');
                updateOrderStatus(update.data.order_id, update.data.status);
                break;
        }
    }
    
    // Подсветка заказа
    function highlightOrder(orderId, className) {
        const orderElement = document.getElementById(`order-${orderId}`);
        if (orderElement) {
            orderElement.classList.add(className);
            setTimeout(() => {
                orderElement.classList.remove(className);
            }, 3000);
        }
    }
    
    // Обновление статуса заказа
    function updateOrderStatus(orderId, newStatus) {
        const statusElement = document.querySelector(`#order-${orderId} .order-status`);
        if (statusElement) {
            statusElement.className = `order-status status-${newStatus}`;
            statusElement.textContent = getStatusText(newStatus);
        }
    }
    
    // Показать уведомление о новом заказе
    function showNewOrderNotification(count) {
        const notification = document.createElement('div');
        notification.className = 'realtime-notification';
        notification.innerHTML = `
            <i class="fas fa-bell"></i>
            <span>${count} новый заказ!</span>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }
    
    // Показать уведомление о заказе
    function showOrderNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'realtime-notification';
        notification.innerHTML = `
            <i class="fas fa-info-circle"></i>
            <span>${message}</span>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }
    
    // Обновление статуса соединения
    function updateConnectionStatus() {
        const indicator = document.getElementById('realtime-indicator');
        if (indicator) {
            if (isConnected) {
                indicator.classList.add('active');
            } else {
                indicator.classList.remove('active');
            }
        }
    }
    
    // Функция для перевода статусов
    function getStatusText(status) {
        const statusMap = {
            'pending': 'Ожидает обработки',
            'preparing': 'Готовится',
            'ready': 'Готов к выдаче',
            'delivered': 'Доставлен',
            'cancelled': 'Отменен'
        };
        return statusMap[status] || status;
    }
    
    // Инициализация обновления в реальном времени
    function initRealtimeUpdates() {
        // Начальная загрузка
        refreshOrders();
        
        // Проверка новых заказов каждые 10 секунд
        checkInterval = setInterval(() => {
            checkForNewOrders();
            checkRealtimeUpdates();
        }, 10000); // 10 секунд
        
        // Также проверяем при возвращении на вкладку
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                checkForNewOrders();
                checkRealtimeUpdates();
            }
        });
    }
    
    // Остановка обновлений
    function stopRealtimeUpdates() {
        if (checkInterval) {
            clearInterval(checkInterval);
        }
    }
    
    // Запуск при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        initRealtimeUpdates();
        
        // Остановка при уходе со страницы
        window.addEventListener('beforeunload', stopRealtimeUpdates);
    });
</script>
{% endblock %}
